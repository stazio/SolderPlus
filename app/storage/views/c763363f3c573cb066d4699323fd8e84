<?php $__env->startSection('title'); ?>
    <title><?php echo $build->version; ?> - <?php echo $build->modpack->name; ?> - TechnicSolder</title>
<?php $__env->stopSection(); ?>
<?php $__env->startSection('top'); ?>
    <script src="<?php echo e(asset('js/selectize.min.js')); ?>"></script>
    <link href="<?php echo e(asset('css/selectize.css')); ?>" rel="stylesheet">
<?php $__env->stopSection(); ?>
<?php $__env->startSection('content'); ?>
<div class="page-header">
<h1>Build Management</h1>
</div>
<div class="panel panel-default">
	<div class="panel-heading">
	<div class="pull-right">
		<a href="<?php echo URL::current(); ?>" class="btn btn-xs btn-warning">Refresh</a>
		<a href="<?php echo URL::to('modpack/build/' . $build->id . '?action=edit'); ?>" class="btn btn-xs btn-danger">Edit</a>
	    <a href="<?php echo URL::to('modpack/view/' . $build->modpack->id); ?>" class="btn btn-xs btn-info">Back to Modpack</a>
		<a href="<?php echo URL::to("modpack/add-build/".$build->modpack->id."?action=clone&build_id=$build->id"); ?>" class="btn btn-xs btn-success">Clone</a>

	</div>
	Build Info: <?php echo $build->modpack->name; ?> - <?php echo $build->version; ?>

	</div>
	<div class="panel-body">
		<div class="col-md-6">
			<label>Build Version:
				<span class="label label-default"><?php echo $build->version; ?>

				</span></label><br>
			<label>Minecraft Version: <span class="label label-default"><?php echo $build->minecraft; ?></span></label><br>
			<div class="form-inline">
				<label for="latest">
					Latest:
				</label>
				<?php if($build->modpack->latest == $build->version): ?>
					<span class="label label-default">Yes</span>
				<?php else: ?>
					<select onchange="update('latest', $(this).val())" id="latest"
							class="form-control input-sm">
						<option>No</option>
						<option value="<?php echo $build->version; ?>">Yes</option>
					</select>
				<?php endif; ?>
			</div>
			<div class="form-inline">
				<label for="published">
					Published:
				</label>
				<select onchange="update('published', $(this).val())" id="published" class="form-control input-sm keep-select">
					<option value="1"  <?php echo $build->is_published == true ? "selected" : ""; ?>>Yes</option>
					<option value="0" <?php echo $build->is_published != true ? "selected" : ""; ?>>No</option>
				</select>
			</div>
		</div>
		<div class="col-md-6">
			<label>Java Version: <span class="label label-default"><?php echo !empty($build->min_java) ? $build->min_java : 'Not Required'; ?></span></label><br>
			<label>Memory (<i>in MB</i>): <span class="label label-default"><?php echo $build->min_memory != 0 ? $build->min_memory : 'Not Required'; ?></span></label>
			<div class="form-inline">
				<label for="recommended">
					Recommended:
				</label>
				<?php if($build->modpack->recommended == $build->version): ?>
					<span class="label label-default">Yes</span>
				<?php else: ?>
				<select onchange="update('recommended', $(this).val())" id="recommended"
						class="form-control input-sm">
						<option>No</option>
						<option value="<?php echo $build->version; ?>">Yes</option>
				</select>
				<?php endif; ?>
			</div>
		</div>
	</div>
</div>
<div class="panel panel-default">
	<div class="panel-heading">
	Build Management: <?php echo $build->modpack->name; ?> - Build <?php echo $build->version; ?>

	</div>
	<div class="panel-body">
		<div class="table-responsive">
			<form method="post" action="<?php echo URL::to('modpack/build/modify'); ?>" class="mod-add">

			<table class="table">
			<thead>
				<tr>
				<th style="width: 60%">Add a Mod</th>
				<th></th>
				<th></th>
				</tr>
			</thead>
			<tbody>
			<input type="hidden" name="build" value="<?php echo $build->id; ?>">
			<input type="hidden" name="action" value="add">
			<tr id="mod-list-add">
				<?php if(Mod::all()->isEmpty()): ?>
					<td>
						No Mods Found.
						<?php echo HTML::link('mod/create', 'Add A Mod', ['class' => 'btn btn-success btn-sm']); ?>

					</td>

					<?php else: ?>
				<td>
					<i class="icon-plus"></i>
					<select class="form-control" name="mod-name" id="mod" placeholder="Select a Mod...">
						<?php foreach(Mod::all() as $mod): ?>
						<option value="<?php echo $mod->name; ?>"><?php echo $mod->pretty_name; ?></option>
						<?php endforeach; ?>
					</select>
				</td>
				<td>
					<select class="form-control" name="mod-version" id="mod-version" placeholder="Select a Modversion...">
					</select>
				</td>
				<td>
					<button type="submit" class="btn btn-success btn-small">Add Mod</button>
				</td>
				<?php endif; ?>
			</tr>
			</tbody>
		</table>
			</form>
		</div>
	</div>
</div>
<div class="panel panel-default">
	<div class="panel-heading">
	Build Management: <?php echo $build->modpack->name; ?> - <?php echo $build->version; ?>

	</div>
	<div class="panel-body">
		<div class="table-responsive">
		<table class="table" id="mod-list">
			<thead>
			<tr>
				<th id="mod-header" style="width: 60%">Mod Name</th>
				<th>Version</th>
				<th></th>
			</tr>
			</thead>
			<tbody>
				<?php foreach($build->modversions->sortByDesc('build_id', SORT_NATURAL) as $ver): ?>
				<tr>
					<td><?php echo HTML::link('mod/view/'.$ver->mod->id, $ver->mod->pretty_name); ?> (<?php echo $ver->mod->name; ?>)</td>
					<td>
						<form method="post" action="<?php echo URL::to('modpack/build/modify'); ?>" style="margin-bottom: 0" class="mod-version">
							<input type="hidden" class="build-id" name="build_id" value="<?php echo $build->id; ?>">
							<input type="hidden" class="modversion-id" name="modversion_id" value="<?php echo $ver->pivot->modversion_id; ?>">
							<input type="hidden" name="action" value="version">
							<div class="form-group input-group">
								<select class="form-control" name="version">
									<?php foreach($ver->mod->versions as $version): ?>
									<option value="<?php echo $version->id; ?>"<?php echo $selected = ($ver->version == $version->version ? 'selected' : ''); ?>><?php echo $version->version; ?></option>
									<?php endforeach; ?>
								</select>
								<span class="input-group-btn">
									<button type="submit" class="btn btn-primary">Change</button>
								</span>
							</div>
						</form>
					</td>
					<td>
						<form method="post" action="<?php echo URL::to('modpack/build/modify'); ?>" style="margin-bottom: 0" class="mod-delete">
							<input type="hidden" name="build_id" value="<?php echo $build->id; ?>">
							<input type="hidden" class="modversion-id" name="modversion_id" value="<?php echo $ver->pivot->modversion_id; ?>">
							<input type="hidden" name="action" value="delete">
							<button type="submit" class="btn btn-danger btn-small">Remove</button>
						</form>
					</td>
				</tr>
				<?php endforeach; ?>
			</tbody>
		</table>
		</div>
	</div>
</div>
<?php $__env->stopSection(); ?>
<?php $__env->startSection('bottom'); ?>
<script type="text/javascript">
if($("#mod").length) {
    var mod = $("#mod").selectize({
        dropdownParent: "body",
        persist: false,
        maxItems: 1,
        sortField: {
            field: 'text',
            direction: 'asc'
        }
    })[0].selectize;

    var modversion = $("#mod-version").selectize({
        dropdownParent: "body",
        persist: false,
        maxItems: 1,
        sortField: {
            field: 'text',
            direction: 'asc'
        }
    })[0].selectize;

    function update(key, value) {
        var url = {
            "latest": "<?php echo URL::to("modpack/modify/latest"); ?>",
            "recommended": "<?php echo URL::to("modpack/modify/recommended"); ?>",
            "published": "<?php echo URL::to("modpack/modify/published"); ?>"
        };

        var data = {
            "build": "<?php echo $build->id; ?>",
            "action": key,
            "modpack": "<?php echo $build->modpack->id; ?>"
        };
        data[key] = value;
        $.ajax({
            type: "POST",
            url: url[key],
            data: data,
            success: function (data) {
                console.log(data);
                if ('success' in data) {
                    $.jGrowl("Modpack updated", {group: 'alert-success'});
                    if (!$("#" + key).hasClass('keep-select'))
                        document.getElementById(key).outerHTML = "<span class='label label-default'>Yes</span>";
                } else {
                    $.jGrowl("Unable to change settings", {group: 'alert-warning'});
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $.jGrowl(textStatus + ': ' + errorThrown, {group: 'alert-danger'});
            }
        });
    }

    $(".mod-version").submit(function (e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "<?php echo URL::to('modpack/modify/version'); ?>",
            data: $(this).serialize(),
            success: function (data) {
                console.log(data);
                if (data.status == 'success') {
                    $.jGrowl("Modversion Updated", {group: 'alert-success'});
                } else if (data.status == 'failed') {
                    $.jGrowl("Unable to update modversion", {group: 'alert-warning'});
                } else if (data.status == 'aborted') {
                    $.jGrowl("Mod was already set to that version", {group: 'alert-success'});
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $.jGrowl(textStatus + ': ' + errorThrown, {group: 'alert-danger'});
            }
        });
    });

    $(".mod-delete").submit(function (e) {
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "<?php echo URL::to('modpack/modify/delete'); ?>",
            data: $(this).serialize(),
            success: function (data) {
                console.log(data.reason);
                if (data.status == 'success') {
                    $.jGrowl("Modversion Deleted", {group: 'alert-success'});
                } else {
                    $.jGrowl("Unable to delete modversion", {group: 'alert-warning'});
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $.jGrowl(textStatus + ': ' + errorThrown, {group: 'alert-danger'});
            }
        });
        $(this).parent().parent().fadeOut();
    });

    $(".mod-add").submit(function (e) {
        e.preventDefault();
        if ($("#mod-version").val()) {
            $.ajax({
                type: "POST",
                url: "<?php echo URL::to('modpack/modify/add'); ?>",
                data: $(this).serialize(),
                success: function (data) {
                    if (data.status === 'success') {
                        $("#mod-list-add").after('<tr><td>' + data.pretty_name + '</td><td>' + data.version + '</td><td></td></tr>');
                        $.jGrowl("Mod " + data.pretty_name + " added at " + data.version, {group: 'alert-success'});
                    } else {
                        $.jGrowl("Unable to add mod. Reason: " + data.reason, {group: 'alert-warning'});
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $.jGrowl(textStatus + ': ' + errorThrown, {group: 'alert-danger'});
                }
            });
        } else {
            $.jGrowl("Please select a Modversion", {group: 'alert-warning'});
        }
    });

    function refreshModVersions() {
        modversion.disable();
        modversion.clearOptions();
        $.ajax({
            type: "GET",
            url: "<?php echo URL::to('api/mod/'); ?>/" + mod.getValue(),
            success: function (data) {
                if (data.versions.length === 0) {
                    $.jGrowl("No Modversions found for " + data.pretty_name, {group: 'alert-warning'});
                    $("#mod-version").attr("placeholder", "No Modversions found...");
                } else {
                    $(data.versions).each(function (e, m) {
                        modversion.addOption({value: m, text: m});
                        modversion.refreshOptions(false);
                        $("#mod-version").attr("placeholder", "Select a Modversion...");
                    });
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $.jGrowl(textStatus + ': ' + errorThrown, {group: 'alert-danger'});
            }
        });
        modversion.enable();
    }

    mod.on('change', refreshModVersions);
    $(document).ready(function(){
        refreshModVersions();
	});
}
$( document ).ready(function() {
	$("#mod-list").dataTable({
    	"order": [[ 0, "asc" ]],
    	"autoWidth": false,
    	"columnDefs": [
			{ "width": "60%", "targets": 0 },
			{ "width": "30%", "targets": 1 }
		]
    });
});
</script>
<?php $__env->stopSection(); ?>

<?php echo $__env->make('layouts/master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>